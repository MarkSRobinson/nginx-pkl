//amends "PklProject"
module io.markrobinson.chart

import "pkl:reflect"
import "pkl:Project"
import "@k8s/K8sObject.pkl"
import "@k8s/api/apps/v1/Deployment.pkl"
import "@k8s/api/core/v1/ConfigMap.pkl"
import "@k8s/api/core/v1/Service.pkl"
import "@k8s/api/core/v1/ServiceAccount.pkl"
import "@k8s/api/networking/v1/Ingress.pkl"
import "@k8s/api/core/v1/LabelSelector.pkl"

import "PklProject"
import "chart.pkl"

selectorLabels {
//   ["app.kubernetes.io/name"] = values.name
  ["app.kubernetes.io/instance"] = "release-name"
}

image {
  repository = "krewh/hardened-nginx"
  tag = "1.1.3"
}

commonLabels  {
  ["hello"] = PklProject.package.version
//   ["helm.sh/chart"] = values.name+"-0.1.0"
  ["app.kubernetes.io/version"] = "1.16.0"
  ["app.kubernetes.io/managed-by"] = "Helm"
}

/// Creates an empty mapping from resource name to resource [type] that defaults `metadata.name` to the resource name.
function resourceMapping(type): Mapping<String, unknown> =
  new Mapping { default = (key) -> (type) {
      metadata {
        name = key
        labels {
          for (k,v in module.commonLabels) {
            [k] = v
          }
          for (k,v in module.selectorLabels) {
            [k] = v
          }
        }
      } } }

output {
    renderer = new YamlRenderer {
      isStream = true
      converters = (K8sObject.output.renderer as YamlRenderer).converters
    }

  // Only emit Mappings
//   value = module.toMap().values.filter( (x) -> (x is Mapping)).flatMap((it) -> it.toMap().values)
  value = total.toMap().values.filter( (x) -> (x is Mapping)).flatMap((it) -> it.toMap().values)
}

hidden config: Mixin<Config>

/// The actual configuration value
total: Config = includes.fold(new Config {
  configMaps = resourceMapping(ConfigMap)
  deployments = resourceMapping(Deployment)
  ingresses = resourceMapping(Ingress)
  services = resourceMapping(Service)
  serviceaccounts = resourceMapping(ServiceAccount)
}, (result, cfg) -> cfg.config.apply(result))

/// The underlying configuration
class Config {
  services: Mapping<String, Service> //= resourceMapping(Service)
  configMaps: Mapping<String, ConfigMap> //= resourceMapping(ConfigMap)
  deployments: Mapping<String, Deployment> //= resourceMapping(Deployment)
  ingresses: Mapping<String, Ingress> //= resourceMapping(Deployment)
  serviceaccounts: Mapping<String, ServiceAccount> //= resourceMapping(Deployment)
}

local includes: Listing<chart> = new {
  import("service.pkl")
  import("configmap.pkl")
  import("deployment.pkl")
  import("ingress.pkl")
  import("serviceaccount.pkl")
}
